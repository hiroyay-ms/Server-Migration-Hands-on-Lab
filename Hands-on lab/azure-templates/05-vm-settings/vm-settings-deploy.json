{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {},
    "variables": {
        "location": "[resourceGroup().location]",

        "sqlVirtualMachineName": "SQL-SVR",
        "sqlAuthenticationLogin": "SqlUser",
        "sqlAuthenticationPassword": "Password.1!!",

        "webCustomScriptFileName": "configure-webvm.ps1",
        "webCustomScriptUri": "[concat('https://raw.githubusercontent.com/hiroyay-ms/Server-Migration-Hands-on-Lab/hiroyay/Hands-on%20lab/azure-templates/05-vm-settings/', variables('sqlCustomScriptFileName'))]",

        "sqlCustomScriptFileName": "configure-sqlvm.ps1",
        "sqlCustomScriptUri": "[concat('https://raw.githubusercontent.com/hiroyay-ms/Server-Migration-Hands-on-Lab/hiroyay/Hands-on%20lab/azure-templates/05-vm-settings/', variables('sqlCustomScriptFileName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.SqlVirtualMachine/sqlVirtualMachines",
            "apiVersion": "2017-03-01-preview",
            "name": "SQL-SVR",
            "location": "[variables('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', variables('sqlVirtualMachineName'))]"
            ],
            "properties": {
                "virtualMachineResourceId": "[resourceId('Microsoft.Compute/virtualMachines', variables('sqlVirtualMachineName'))]",
                "sqlManagement": "Full",
                "sqlServerLicenseType": "PAYG",
                "autoPatchingSettings": {
                    "enable": false
                },
                "serverConfigurationsManagementSettings": {
                    "sqlConnectivityUpdateSettings": {
                        "connectivityType": "PRIVATE",
                        "port": 1433,
                        "sqlAuthUpdateUserName": "[variables('sqlAuthenticationLogin')]",
                        "sqlAuthUpdatePassword": "[variables('sqlAuthenticationPassword')]"
                    },
                    "additionalFeaturesServerConfigurations": {
                        "isRServicesEnabled": false
                    }
                }
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "apiVersion": "2019-03-01",
            "name": "SetupSqlVM",
            "location": "[variables('location')]",
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', variables('sqlVirtualMachineName'))]"
            ],
            "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.9",
                "autoUpgradeMinorVersion": true,
                "settings": {
                    "fileUris": [
                        "[variables('sqlCustomScriptUri')]"
                    ],
                    "commandToExecute": "[concat('powershell -ExecutionPolicy Unrestricted -File ', variables('sqlCustomScriptFileName'))]"
                }
            }
        }
    ]
}